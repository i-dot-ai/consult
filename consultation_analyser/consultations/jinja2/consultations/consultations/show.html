{% extends "base.html" %}
{%- from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}

{% set page_title = "All Questions" %}

{% block content %}

  {{ govukBreadcrumbs({
    "items": [
      {
        "text": "Back to all consultations",
        "href": "/consultations",
      }
    ]
  }) }}

  <style>
    .govuk-main-wrapper {
      background: white;
    }
  </style>

  <div id="loading" class="govuk-body">Loading consultation...</div>

  <div id="error-message" style="display: none;" class="govuk-error-message">
    <span class="govuk-visually-hidden">Error:</span> Failed to load consultation. Please try refreshing the page.
  </div>

  <div id="consultation-content" style="display: none;">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <iai-question-overview-page></iai-question-overview-page>
      </div>
    </div>
  </div>

  <script>
    // Get consultation slug from Django context
    const consultationId = '{{ consultation_id }}';

    async function loadConsultationData() {
      try {
        // Get consultation directly by slug using filter
        const consultationsResponse = await fetch(`/api/consultations/?pk=${encodeURIComponent(consultationId)}`, {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        if (!consultationsResponse.ok) {
          throw new Error(`HTTP error! status: ${consultationsResponse.status}`);
        }

        const consultationsData = await consultationsResponse.json();
        const consultations = consultationsData.results || consultationsData;

        if (consultations.length === 0) {
          throw new Error('Consultation not found');
        }

        const consultation = consultations[0];

        // Get questions for this consultation
        const questionsResponse = await fetch(`/api/consultations/${consultation.id}/questions/`, {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        if (!questionsResponse.ok) {
          throw new Error(`HTTP error! status: ${questionsResponse.status}`);
        }

        const questionsData = await questionsResponse.json();
        // Handle both paginated and non-paginated API responses
        const questions = questionsData.results || questionsData;

        // Populate the web component
        const questionOverviewPage = document.getElementsByTagName("iai-question-overview-page")[0];

        questionOverviewPage.consultationName = consultation.title;
        questionOverviewPage.questions = questions.map(question => ({
          id: question.id,
          title: `Q${question.number}: ${question.question_text}`,
          url: `/consultations/${consultation.id}/responses/${question.id}/`,
          numResponses: question.total_responses,
          status: "Open",
        }));

        // Hide loading and show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('consultation-content').style.display = 'block';

      } catch (error) {
        console.error('Error loading consultation data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // Load consultation data when page loads
    document.addEventListener('DOMContentLoaded', loadConsultationData);
  </script>

  <noscript>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <div class="govuk-warning-text">
          <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
          <strong class="govuk-warning-text__text">
            <span class="govuk-warning-text__assistive">Warning</span>
            JavaScript is required to view this page. Please enable JavaScript in your browser.
          </strong>
        </div>
      </div>
    </div>
  </noscript>


{% endblock %}
