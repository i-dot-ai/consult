{% extends "base.html" %}
{%- from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}

{% set page_title = "All Questions" %}

{% block content %}

  {{ govukBreadcrumbs({
    "items": [
      {
        "text": "Back to all consultations",
        "href": "/consultations",
      }
    ]
  }) }}

  <style>
    .govuk-main-wrapper {
      background: white;
    }
  </style>

  <div id="loading" class="govuk-body">Loading consultation...</div>
  
  <div id="error-message" style="display: none;" class="govuk-error-message">
    <span class="govuk-visually-hidden">Error:</span> Failed to load consultation. Please try refreshing the page.
  </div>

  <div id="consultation-content" style="display: none;">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <iai-question-overview-page></iai-question-overview-page>
      </div>
    </div>
  </div>

  <script>
    // Get consultation ID from Django context
    const consultationId = '{{ consultation_id }}';
    
    async function loadConsultationData() {
      try {
        // Get consultation directly by ID
        const consultationResponse = await fetch(`/api/consultations/${consultationId}/`, {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        if (!consultationResponse.ok) {
          throw new Error(`HTTP error! status: ${consultationResponse.status}`);
        }

        const consultation = await consultationResponse.json();

        // Get questions for this consultation
        const questionsResponse = await fetch(`/api/consultations/${consultationId}/questions/`, {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        if (!questionsResponse.ok) {
          throw new Error(`HTTP error! status: ${questionsResponse.status}`);
        }

        const questionsData = await questionsResponse.json();
        const questions = questionsData.results || questionsData;

        // Populate the web component
        const questionOverviewPage = document.getElementsByTagName("iai-question-overview-page")[0];
        
        questionOverviewPage.consultationName = consultation.title;
        questionOverviewPage.questions = questions.map(question => ({
          id: question.id,
          title: `Q${question.number}: ${question.question_text}`,
          url: `/consultations/${consultation.slug}/responses/${question.slug}/`,
          numResponses: question.total_responses,
          status: "Open",
        }));

        // Hide loading and show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('consultation-content').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading consultation data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // Load consultation data when page loads
    document.addEventListener('DOMContentLoaded', loadConsultationData);
  </script>

  <noscript>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-three-quarters">

        <div class="govuk-grid-row">
          <div class="govuk-grid-column-full">

            {% for question_dict in questions_list %}
              <div class="iai-panel govuk-!-margin-bottom-4">
                <span class="govuk-caption-m "><a class="govuk-link" href="{{ url('question_responses', kwargs={'consultation_slug': consultation.slug, 'question_slug': question_dict.question.slug}) }}">Question {{ question_dict.question.number }}</a></span>
                <h2 class="govuk-heading-m govuk-!-margin-top-1">{{ question_dict.question.text }}</h2>

                {% if question_dict.free_text_question_part %}
                    <h3 class="govuk-heading-s">Free text response</h3>
                    <p class="govuk-body">
                      This question has {{ question_dict.free_text_count }} free text responses.
                    </p>
                {% else %}
                  <p class="govuk-body">This question does not have free text responses</p>
                {% endif %}

                <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

                {% if question_dict.multiple_option_question_part %}
                  <h3 class="govuk-heading-s">Response to multiple choice</h3>
                  {% for key, value in question_dict.multiple_option_counts.items() %}
                      <p>{{key}}: {{value}}</p>
                   {% endfor %}
                {% else %}
                  <p class="govuk-body">This question does not have a multiple choice part</p>
                {% endif %}

              </div>
            {% endfor %}

            {% from "components/pagination.html" import render_pagination %}
            {{ render_pagination(pagination) }}

          </div>
        </div>
      </div>
    </div>
  </noscript>


{% endblock %}
