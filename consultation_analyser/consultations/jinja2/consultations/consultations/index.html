{% extends "base.html" %}

{% set page_title = "Your consultations" %}

{% block content %}

  <h1 class="govuk-heading-l">{{ page_title }}</h1>

  <div id="loading" class="govuk-body">Loading consultations...</div>

  <div id="consultations-container" style="display: none;">
    <p class="govuk-body">Click to review themes for your consultations</p>
    <ul id="consultations-list" class="govuk-list"></ul>
  </div>

  <div id="no-consultations" style="display: none;">
    <p class="govuk-body">You do not have any consultations</p>
  </div>

  <div id="error-message" style="display: none;" class="govuk-error-message">
    <span class="govuk-visually-hidden">Error:</span> Failed to load consultations. Please try refreshing the page.
  </div>

  <script>
    let userHasDashboardAccess = false;

    async function loadUserData() {
      try {
        const response = await fetch('/api/user/', {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const userData = await response.json();
        userHasDashboardAccess = userData.has_dashboard_access;
      } catch (error) {
        console.error('Error loading user data:', error);
        // Default to false if we can't load user data
        userHasDashboardAccess = false;
      }
    }

    async function loadConsultations() {
      try {
        const response = await fetch('/api/consultations/', {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const consultations = data.results;

        const loadingEl = document.getElementById('loading');
        const containerEl = document.getElementById('consultations-container');
        const noConsultationsEl = document.getElementById('no-consultations');
        const listEl = document.getElementById('consultations-list');

        loadingEl.style.display = 'none';

        if (consultations.length === 0) {
          noConsultationsEl.style.display = 'block';
          return;
        }

        // Build consultations list
        listEl.innerHTML = consultations.map(consultation => `
          <li class="govuk-!-margin-top-2 govuk-!-margin-bottom-6">
            <h2 class="govuk-heading-m">${consultation.title}</h2>
            <a href="/evaluations/${consultation.id}/questions/"
               class="govuk-body-l govuk-link govuk-link--no-visited-state govuk-!-margin-right-5">
              View evaluation
            </a>
            ${userHasDashboardAccess ? `
              <a href="/consultations/${consultation.id}/"
                 class="govuk-body-l govuk-link govuk-link--no-visited-state govuk-!-margin-right-5">
                View dashboard
              </a>
            ` : ''}
          </li>
        `).join('');

        containerEl.style.display = 'block';

      } catch (error) {
        console.error('Error loading consultations:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load user data and consultations when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserData();
      await loadConsultations();
    });
  </script>

{% endblock %}
