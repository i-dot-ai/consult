{% extends "base.html" %}
{%- from 'govuk_frontend_jinja/components/back-link/macro.html' import govukBackLink -%}
{%- from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}

{% set page_title = "Response explorer" %}

{% block content %}

  <noscript>
    <p class="govuk-heading-s">{{ consultation_name }}</p>
  </noscript>

  {{ govukBreadcrumbs({
    "items": [
      {
        "text": "All consultations",
        "href": "/consultations",
      },
      {
        "text": "All questions",
        "href": "/consultations/" + consultation_slug
      }
    ]
  }) }}

<noscript>
  <div class="govuk-grid-row govuk-!-margin-top-5">
    <div class="govuk-grid-column-full">
      <span class="govuk-caption-xl govuk-!-display-block">Question {{question.number}}</span>
      <h1
        class="govuk-heading-l"
      >
        {{ question.text }}
      </h1>
      {% if free_text_question_part %}
        <h2 class="govuk-heading-m govuk-!-font-weight-regular">
          {{ free_text_question_part.text }}
        </h2>
      {% endif %}
    </div>
  </div>

  <div class="govuk-grid-row govuk-!-margin-top-5">
    <div class="govuk-grid-column-full">
      <span class="govuk-caption-m">{{ total_responses }} responses</span>
      <h2 class="govuk-heading-m">Overview</h2>
      
      {% if free_text_question_part %}
        <div class="iai-panel govuk-!-margin-bottom-8">
          <h2 class="govuk-heading-m">Top themes</h2>
          <details class="govuk-details">
            <summary class="govuk-details__summary">
              <span class="govuk-details__summary-text">
                Help with themes
              </span>
            </summary>
            <div class="govuk-details__text">
              <p class="govuk-body">Themes are AI-generated by spotting trends from the individual responses to the question. A single response could have more than 1 theme. 
            The table below represents the number of times a theme appears in the response, and if it was a positive or negative mention of that theme.
            </p></div>
          </details>

          <table class="govuk-table govuk-body" mentionstable="">
            <thead class="govuk-table__head">
              <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header">Theme name</th>
                <th scope="col" class="govuk-table__header">Total mentions</th>
                <th scope="col" class="govuk-table__header">Positive mentions</th>
                <th scope="col" class="govuk-table__header">Negative mentions</th>
              </tr>
            </thead>
          
            <tbody class="govuk-table__body">
              {% for theme_mapping in selected_theme_mappings %}
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header"><tool-tip class="iai-tooltip"><div class="iai-tooltip__button" role="tooltip" tabindex="0" aria-describedby="tooltip-content-3fbe5d4c-c46c-426d-a004-516a28dc2fad"><span>{{theme_mapping.theme__name}}</span> <img src="{{ static('icons/question-mark.svg') }}" alt="" width="14"></div><div class="iai-tooltip__content" id="tooltip-content-3fbe5d4c-c46c-426d-a004-516a28dc2fad" style="display: none;">{{theme_mapping.theme__description}}</div></tool-tip></th>
                  <td class="govuk-table__cell">{{theme_mapping.count}}</td>
                  <!-- TODO: add percentages and whether bold -->
                  <td class="govuk-table__cell">{{theme_mapping.positive_count}}</td>
                  <td class="govuk-table__cell">{{theme_mapping.negative_count}}</td>
                </tr>
              {% endfor %}
              <tr class="new-class">
                <td class="govuk-table__cell"><b>All themes</b></td>
                <td class="govuk-table__cell">{{theme_mapping_summary.total}}</td>
                <td class="govuk-table__cell">{{theme_mapping_summary.positive}}</td>
                <td class="govuk-table__cell">{{theme_mapping_summary.negative}}</td>
              </tr>
            </tbody>
          </table>

          <iai-csv-download id="csv_download_themes" fileName="themes.csv"></iai-csv-download>
          <script>document.getElementById("csv_download_themes").data = {{ csv_button_data | safe }}</script>

          <!-- TODO: add data visualisation -->

        </div>
      {% endif %}
    </div>
  </div>
</noscript>

<iai-response-dashboard></iai-response-dashboard>
<script>
  const responseDashboardEl = document.getElementsByTagName("iai-response-dashboard")[0];

  responseDashboardEl.consultationTitle = "{{ consultation_name }}";
  responseDashboardEl.questionTitle = "Question {{question.number}}";
  responseDashboardEl.questionText = "{{ question.text }}";
  responseDashboardEl.responses = [
    {% for respondent in all_respondents %}
      {
        id: "response-{{ respondent.identifier | default('') }}",
        identifier: "{{ respondent.identifier | default('') }}",
        individual: "{{ respondent.individual | default('') }}",
        sentiment_position: "{{ (respondent.sentiment and respondent.sentiment.position) | default('') }}",
        free_text_answer_text: "{{ (respondent.free_text_answer and respondent.free_text_answer.text) | default('') }}",
        demographic_data: "{{ respondent.demographic_data | default('') }}",
        themes: [
          {% for theme in respondent.themes %}
            {
              id: "{{ theme.theme.id }}",
              stance: "{{ theme.stance }}",
              name: "{{ theme.theme.name }}",
              description: "{{ theme.theme.description | safe }}",
            },
          {% endfor %}
        ],
        
        {% if respondent.multiple_choice_answer and respondent.multiple_choice_answer.chosen_options %}
          multiple_choice_answer: {{ respondent.multiple_choice_answer.chosen_options | safe }},
        {% else %}
          multiple_choice_answer: [],
        {% endif %}
      },
    {% endfor %}
  ];

  responseDashboardEl.themeMappings = [
      {% for theme_mapping in selected_theme_mappings %}
        {
          inputId: "themesfilter-{{loop.index0}}",
          value: "{{ theme_mapping.theme__id }}",
          label: "{{ theme_mapping.theme__name }}",
          description: "{{ theme_mapping.theme__description | safe }}",
          count: "{{ theme_mapping.count }}",
        },
      {% endfor %}
  ];

  responseDashboardEl.stanceOptions = [
    {% for option in stance_options %}
      {
          inputId: "responsesentiment-{{loop.index0}}",
          name: "responsesentiment",
          value: "{{option}}",
          label: "{{ option|capitalize }}",
      },
    {% endfor %}
  ];
  
  responseDashboardEl.free_text_question_part = {% if free_text_question_part %}true{% else %}false{% endif %};
  responseDashboardEl.has_individual_data = {% if has_individual_data %}true{% else %}false{% endif %};
  responseDashboardEl.has_multiple_choice_question_part = {% if has_multiple_choice_question_part %}true{% else %}false{% endif %};

  responseDashboardEl.multiple_choice_summary = [
  {% if has_multiple_choice_question_part %}
      {% for summary in multiple_choice_summary %}
        {% for option, count in summary.items() %}
          {"{{ option }}": {{ count }}},
        {% endfor %}
      {% endfor %}
    {% endif %}
  ];
</script>

<noscript>
  <div class="govuk-grid-row govuk-!-margin-top-5">
    <div class="govuk-grid-column-one-quarter-from-desktop">

      <div class="iai-filter">
        <div class="iai-filter__header">
          <div class="iai-filter__header-title">
            <h2 class="govuk-heading-m">Filter</h2>
          </div>
        </div>
      
        <div class="iai-filter__content">
          {% if has_filters %}
            <div class="iai-filter__selected">
              <div class="iai-filter__selected-heading">
                  <div class="iai-filter__heading-title">
                    <h2 class="govuk-heading-m govuk-!-margin-bottom-0">Selected filters</h2>
                  </div>
                  <a class="iai-filter__tag" href={{request.path}}> Remove all filters</a>
                  
                  {% for type, options in active_filters.items() %}
                  {% if options.selected %}
                  <h3 class="govuk-heading-s govuk-!-margin-bottom-0 govuk-!-margin-top-5">{{ options.label }}</h3>
                  
                  <ul class="iai-filter-tags">
                    {% for option in options.selected %}
                    <li><a class="iai-filter__tag" href={{"?" + remove_query_param(request, type, option.id)}}><span class="govuk-visually-hidden">Remove this filter</span> {{ option.display }}</a></li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endif %}
  
          <form method="GET">
            <div class="iai-filter__options">
              <button aria-disabled="true" type="submit" id="filter-button" class="govuk-button" data-module="govuk-button" data-test-id="submit-button" data-govuk-button-init="">
                Apply filters
              </button>
              
              {% if display_respondent_id_filter %}
                <div class="govuk-form-group">
                  <label class="govuk-label govuk-label--m" for="responseid">
                    Respondent ID
                  </label>
                  <input class="govuk-input govuk-!-width-one-third" id="responseid" name="responseid" type="text" {% if active_filters.responseid.selected %} value="{{ active_filters.responseid.selected[0].display }}" {% endif %}>
                </div>
              {% endif %}

              {% if has_individual_data %}
                <div class="govuk-form-group">
                  <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                      Respondent type
                    </legend>
        
                    <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes" data-govuk-checkboxes-init="">
                      <div class="govuk-checkboxes__item">
                        <input class="govuk-checkboxes__input" id="demographicindividual-0" name="demographicindividual" type="checkbox" value="Individual"
                        {% if is_in("Individual", active_filters.demographicindividual.selected) %}
                          checked
                        {% endif %}
                        >
                        <!-- TODO: add % e.g. Organisation: 48 (15%) -->
                        <label class="govuk-label govuk-checkboxes__label" for="demographicindividual-0">
                          Individual
                        </label>
                      </div>
                      <div class="govuk-checkboxes__item">
                        <input class="govuk-checkboxes__input" id="demographicindividual-1" name="demographicindividual" type="checkbox" value="Organisation"
                        {% if is_in("Organisation", active_filters.demographicindividual.selected) %}
                          checked
                        {% endif %}
                        >
                        <label class="govuk-label govuk-checkboxes__label" for="demographicindividual-1">
                          Organisation
                        </label>
                      </div>
                    </div>
                  </fieldset>
                </div>
              {% endif %}
              
              {% if free_text_question_part %}
                <div class="govuk-form-group">
                  <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                      Themes
                    </legend>
                    <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes" data-govuk-checkboxes-init="">
                      {% for theme_mapping in theme_mappings %}
                        <div class="govuk-checkboxes__item">
                          <input class="govuk-checkboxes__input" id="themesfilter-{{loop.index0}}" name="themesfilter" type="checkbox" value={{theme_mapping.theme__id}}
                          {% if is_in(theme_mapping.theme__id, active_filters.themesfilter.selected) %}
                            checked
                          {% endif %}
                          >
                          <label class="govuk-label govuk-checkboxes__label" for="themesfilter-{{loop.index0}}">
                            {{ theme_mapping.theme__name }}
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </fieldset>
                </div>
              
  
                <div class="govuk-form-group">
                  <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                      Theme sentiment
                    </legend>
    
                    <div class="govuk-radios" data-module="govuk-radios" data-govuk-radios-init="">
                      {% for option in theme_stance_options %}
                        <div class="govuk-radios__item">
                          <input class="govuk-radios__input" id="themesentiment-{{loop.index0}}" name="themesentiment" type="radio" value={{option}} {% if active_filters.themesentiment.selected %}{% if option == active_filters.themesentiment.selected[0].id %} checked {% endif %} {% endif %}>
                          <label class="govuk-label govuk-radios__label" for="themesentiment-{{loop.index0}}">
                            {{ option|capitalize }}
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </fieldset>
                </div>
              {% endif %}
  
              <div class="govuk-form-group">
                <fieldset class="govuk-fieldset">
                  <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                    Response sentiment
                  </legend>
                  <div class="govuk-radios" data-module="govuk-radios" data-govuk-radios-init="">
                    {% for option in stance_options %}
                      <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="responsesentiment-{{loop.index0}}" name="responsesentiment" type="radio" value={{option}} {% if active_filters.responsesentiment.selected %}{% if option == active_filters.responsesentiment.selected[0].id %} checked {% endif %}{% endif %}>
                        <label class="govuk-label govuk-radios__label" for="responsesentiment-{{loop.index0}}">
                          {{ option|capitalize }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                </fieldset>
              </div>
          
            {% if free_text_question_part %}
              <div class="govuk-form-group">
                <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                  Response word count
                </legend>
      
                <div class="govuk-input__wrapper">
                  <label class="govuk-label govuk-label--m govuk-!-margin-right-2 v-centered" for="wordcount">
                    Minimum:
                  </label>
                  <input class="govuk-input govuk-input--width-5 govuk-input--full-border" id="wordcount" name="wordcount" type="number" spellcheck="false" {% if active_filters.wordcount.selected %} value="{{ active_filters.wordcount.selected[0].id }}" {% endif %} />
                </div>
              </div>
            {% endif %}
                  
            </div>
          </form>
      
        </div>
      
      </div>
    </div>

    <div class="govuk-grid-column-three-quarters-from-desktop">
      {% if has_multiple_choice_question_part %}
        <div class="iai-panel govuk-!-margin-bottom-8">
          <!-- Display unique multiple choice options with counts -->
          {% for summary in multiple_choice_summary %}
            <table class="govuk-table" responsetomultiplechoice="">
              <caption class="govuk-table__caption govuk-table__caption--m">Response to multiple choice</caption>
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                  <th scope="col" class="govuk-table__header">Response type</th>
                  <th scope="col" class="govuk-table__header">Response rate</th>
                </tr>
              </thead>
              <tbody class="govuk-table__body">

                {% for option, count in summary.items() %}
                  <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">{{ option }}</th>
                    <td class="govuk-table__cell">{{ count }}</td>
                  </tr>
                {% endfor %}
    
              </tbody>
            </table>
          {% endfor %}
      
          <!-- TODO: add data visualisation -->
        </div>
      {% endif %}

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
          <span class="govuk-caption-m">{{ total_responses }} responses</span>
          <h2 class="govuk-heading-m">Individual responses</h2>
        </div>
      </div>

      <!-- TODO: add sorting options here -->
      
      {# Responses #}

      {% for respondent in respondents %}
        <div class="iai-panel response govuk-!-margin-bottom-4">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              {% if respondent.individual %}
                <span class="govuk-caption-m">{{ respondent.individual }}</span>
              {% endif %}
              <h2 class="govuk-heading-m">
                Respondent {{ respondent.identifier }}
              </h2>
            </div>
            <!-- TODO: add pin here -->
            <!-- <div class="govuk-grid-column-one-third">
              <a class="pin-response align-right">
                <p class="govuk-body-s govuk-!-margin-bottom-0" style="display: flex; align-items: center;">
                  <img src="/public/images/pin-response.svg" alt="Pin response">
                  <span>Pin response</span>
                </p>
              </a>
            </div> -->
          </div>
            {% if respondent.free_text_answer %}
              <h3 class="govuk-heading-s govuk-!-margin-bottom-4">Free text response</h3>
              {% if respondent.sentiment %}
                <p class="govuk-body" style="display: flex; align-items: center; gap: 0.6%;">
                  {% if respondent.sentiment.position == "AGREEMENT" %}
                    <img src="{{ static('icons/thumbs-up.svg') }}" alt="icon" style="width: 24px; height: 24px;">
                  {% elif respondent.sentiment.position == "DISAGREEMENT" %}
                    <img src="{{ static('icons/thumbs-down.svg') }}" alt="icon" style="width: 24px; height: 24px;">
                  {% else %}
                    <img src="{{ static('icons/thumbs-up-down.svg') }}" alt="icon" style="width: 24px; height: 24px;">
                  {% endif %}
                  <span>{{ respondent.sentiment.position|capitalize }}</span>
                </p>
              {% endif %}

              {% for theme in respondent.themes %}

                <div class="govuk-pill-container" style="display: flex; align-items: center; gap: 0.6%;">
                  <div class="govuk-pill">
                    <tool-tip class="iai-tooltip">
                      <div class="iai-tooltip__button" role="tooltip" tabindex="0" aria-describedby="tooltip-content-2a1c358a-162a-4cf8-8011-43c13ef22785">
                        {% if theme.stance == "POSITIVE" %}
                          <img src="{{ static('icons/tick.svg') }}" alt="icon" style="width: 24px; height: 24px;">
                        {% else %}
                          <img src="{{ static('icons/warning.svg') }}" alt="icon" style="width: 24px; height: 24px;">
                        {% endif %}
                        <span>{{ theme.theme.name }}</span>
                        <img src="{{ static('icons/question-mark.svg') }}" alt="info" width="14">
                      </div>
                      <div class="iai-tooltip__content" id="tooltip-content-2a1c358a-162a-4cf8-8011-43c13ef22785">
                        {{ theme.theme.description }}
                      </div>
                    </tool-tip>
                  </div>
                </div>
              
              {% endfor %}

              <p class="govuk-body" style="line-height: 2em;">
                {{ respondent.free_text_answer.text or "No free text answer given" }}
              </p>
            {% endif %}

            {% if has_multiple_choice_question_part %}
              <h3 class="govuk-heading-s govuk-!-margin-bottom-2">Response to multiple choice</h3>
              {% if respondent.multiple_choice_answer %}
                <p class="govuk-body" style="line-height: 2em;">
                  {{ respondent.multiple_choice_answer.chosen_options|join(", ") }}
                </p>
              {% else %}
              <p class="govuk-body" style="line-height: 2em;">
                Not answered
              </p>
              {% endif %}
            {% endif %}
          {% if respondent.demographic_data %}
            <p class="govuk-body-s">{{ respondent.demographic_data }}</p>
          {% endif %}
        </div>
      {% endfor %}

      {# Pagination #}
        {% if pagination.paginator.num_pages > 1 %}
          <nav class="govuk-pagination" role="navigation" aria-label="Pagination">

            {% if pagination.number > 1 %}
              <div class="govuk-pagination__prev">
                <a class="govuk-link govuk-pagination__link" href={{"?" + replace_query_param(request, "page", pagination.number - 1)}} rel="prev">
                  <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                    <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
                  </svg>
                  <span class="govuk-pagination__link-title">
                    Previous<span class="govuk-visually-hidden"> page</span>
                  </span>
                </a>
              </div>
            {% endif %}

            <ul class="govuk-pagination__list">

              {% if pagination.number > 2 %}
                <li class="govuk-pagination__item">
                  <a class="govuk-link govuk-pagination__link" href="?page=1" aria-label="Page 1">
                    1
                  </a>
                </li>
                <li class="govuk-pagination__item govuk-pagination__item--ellipses">
                  &ctdot;
                </li>
              {% endif %}

              {% if pagination.has_previous() %}
                <li class="govuk-pagination__item">
                  <a class="govuk-link govuk-pagination__link" href={{"?" + replace_query_param(request, "page", pagination.previous_page_number())}} aria-label="Page {{ pagination.previous_page_number() }}">
                    {{ pagination.previous_page_number() }}
                  </a>
                </li>
              {% endif %}
              <li class="govuk-pagination__item govuk-pagination__item--current">
                <a class="govuk-link govuk-pagination__link" href={{"?" + replace_query_param(request, "page", pagination.number)}} aria-label="Page {{ pagination.number }}" aria-current="page">
                  {{ pagination.number }}
                </a>
              </li>

              {% if pagination.has_next() %}
                <li class="govuk-pagination__item">
                  <a class="govuk-link govuk-pagination__link" href={{"?" + replace_query_param(request, "page", pagination.next_page_number())}} aria-label="Page {{ pagination.next_page_number() }}">
                    {{ pagination.next_page_number() }}
                  </a>
                </li>
              {% endif %}

              {% if pagination.paginator.num_pages > pagination.number + 1 %}
                <li class="govuk-pagination__item govuk-pagination__item--ellipses">
                  &ctdot;
                </li>
                <li class="govuk-pagination__item">
                  <a class="govuk-link govuk-pagination__link" href={{"?" + replace_query_param(request, "page", pagination.paginator.num_pages)}} aria-label="Page {{ pagination.paginator.num_pages }}">
                    {{ pagination.paginator.num_pages }}
                  </a>
                </li>
              {% endif %}

            </ul>

            {% if pagination.has_next() %}
              <div class="govuk-pagination__next">
                <a class="govuk-link govuk-pagination__link" href={{"?" + replace_query_param(request, "page", pagination.next_page_number())}} rel="next">
                  <span class="govuk-pagination__link-title">
                    Next<span class="govuk-visually-hidden"> page</span>
                  </span>
                  <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                    <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
                  </svg>
                </a>
              </div>
            {% endif %}

          </nav>
        {% endif %}

    </div>

  </div>
</noscript>

{% endblock %}
