{% extends "base.html" %}
{%- from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}
{%- from 'govuk_frontend_jinja/components/input/macro.html' import govukInput -%}
{%- from 'govuk_frontend_jinja/components/textarea/macro.html' import govukTextarea -%}

{% block content %}
  <h1 class="govuk-heading-m" id="page-title">{{ "Edit Theme" if theme_id else "Add New Theme" }}</h1>
  {{ govukBreadcrumbs({
    "items": [
      {
        "text": "Back to your consultations",
        "href": "/consultations",
      },
      {
        "text": "Questions",
        "href": "/evaluations/" + consultation_id|string + "/questions/",
      },
      {
        "text": "Themes",
        "href": "/evaluations/" + consultation_id|string + "/questions/" + question_id|string + "/themes/",
      }
    ]
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <div class="govuk-section-break govuk-section-break--m"></div>

      <form id="theme-form">
        <div class="govuk-form-group">
          {{ govukInput({
            "label": {
              "text": "Theme Name",
              "classes": "govuk-label--s"
            },
            "hint": {
              "text": "Enter a descriptive name for this theme"
            },
            "id": "name",
            "name": "name",
            "classes": "govuk-!-width-full"
          }) }}
        </div>

        <div class="govuk-form-group">
          {{ govukTextarea({
            "label": {
              "text": "Theme Description",
              "classes": "govuk-label--s"
            },
            "hint": {
              "text": "Provide a detailed description of what this theme represents"
            },
            "id": "description",
            "name": "description",
            "rows": 5
          }) }}
        </div>

        <div class="govuk-button-group">
          {{ govukButton({
            "text": "Save Theme",
            "type": "submit",
            "id": "save-btn"
          }) }}

          <a href="/evaluations/{{ consultation_id }}/questions/{{ question_id }}/themes/"
             class="govuk-button govuk-button--secondary">Cancel</a>
        </div>
      </form>

      <div id="responses-section" style="display: none;">
        <div class="govuk-section-break govuk-section-break--l"></div>

        <div class="govuk-form-group">
          <h2 class="govuk-heading-s">Example Responses</h2>
          <p class="govuk-hint">See responses that might be related to this theme</p>

          <button type="button" id="see-responses-btn" class="govuk-button govuk-button--secondary">
            See Example Responses
          </button>

          <div id="responses-container" style="display: none; margin-top: 20px;">
            <h3 class="govuk-heading-s">Related Responses</h3>
            <div id="responses-list">
              <!-- Responses will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const consultationId = '{{ consultation_id }}';
      const questionId = '{{ question_id }}';
      const themeId = '{{ theme_id }}' || null;
      const apiUrl = `/api/consultations/${consultationId}/questions/${questionId}/themes/`;
      
      const form = document.getElementById('theme-form');
      const nameInput = document.getElementById('name');
      const descriptionInput = document.getElementById('description');
      const saveBtn = document.getElementById('save-btn');
      const responsesSection = document.getElementById('responses-section');
      
      // Load existing theme data if editing
      if (themeId) {
        loadThemeData();
        responsesSection.style.display = 'block';
      }
      
      // Handle form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        saveTheme();
      });
      
      function loadThemeData() {
        fetch(`${apiUrl}${themeId}/`)
          .then(response => response.json())
          .then(theme => {
            nameInput.value = theme.name || '';
            descriptionInput.value = theme.description || '';
          })
          .catch(error => {
            console.error('Error loading theme:', error);
            alert('Error loading theme data. Please refresh the page.');
          });
      }
      
      function saveTheme() {
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();
        
        if (!name) {
          alert('Theme name is required.');
          nameInput.focus();
          return;
        }
        
        // Show loading state
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;
        
        const data = {
          name: name,
          description: description
        };
        
        const url = themeId ? `${apiUrl}${themeId}/` : apiUrl;
        const method = themeId ? 'PUT' : 'POST';
        
        fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify(data)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Success - redirect to theme list
          window.location.href = `/evaluations/${consultationId}/questions/${questionId}/themes/`;
        })
        .catch(error => {
          console.error('Error saving theme:', error);
          alert('Failed to save theme. Please try again.');
        })
        .finally(() => {
          saveBtn.textContent = 'Save Theme';
          saveBtn.disabled = false;
        });
      }
      
      function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      }
      
      // Example responses functionality (only available when editing)
      if (themeId) {
        const seeResponsesBtn = document.getElementById('see-responses-btn');
        const responsesContainer = document.getElementById('responses-container');
        const responsesList = document.getElementById('responses-list');
        let isShowing = false;

        seeResponsesBtn.addEventListener('click', function() {
          if (isShowing) {
            // Hide responses
            responsesContainer.style.display = 'none';
            seeResponsesBtn.textContent = 'See Example Responses';
            isShowing = false;
          } else {
            // Show responses
            loadExampleResponses();
          }
        });

        function loadExampleResponses() {
          // Show loading state
          seeResponsesBtn.textContent = 'Loading...';
          seeResponsesBtn.disabled = true;

          const responsesApiUrl = `${apiUrl}${themeId}/responses/`;

          fetch(responsesApiUrl)
            .then(response => response.json())
            .then(data => {
              displayResponses(data);
            })
            .catch(error => {
              console.error('Error getting responses:', error);
              alert('Error getting responses. Please try again.');
            })
            .finally(() => {
              seeResponsesBtn.disabled = false;
            });
        }

        function displayResponses(responses) {
          // Clear previous responses
          responsesList.innerHTML = '';

          if (!responses || responses.length === 0) {
            responsesList.innerHTML = '<p class="govuk-body">No similar responses found for this theme.</p>';
          } else {
            // Create list of responses
            const responseList = document.createElement('ol');
            responseList.className = 'govuk-list govuk-list--number';

            responses.forEach(response => {
              const listItem = document.createElement('li');
              listItem.className = 'govuk-!-margin-bottom-3';
              listItem.innerHTML = `<p class="govuk-body-s" style="background: #f3f2f1; padding: 10px; border-radius: 3px;">${escapeHtml(response.free_text)}</p>`;
              responseList.appendChild(listItem);
            });

            responsesList.appendChild(responseList);

            // Add count information
            const countInfo = document.createElement('p');
            countInfo.className = 'govuk-body-s govuk-!-margin-top-3';
            countInfo.style.color = '#626a6e';
            countInfo.textContent = `Showing ${responses.length} example responses`;
            responsesList.appendChild(countInfo);
          }

          // Show the responses container
          responsesContainer.style.display = 'block';

          // Update button text
          seeResponsesBtn.textContent = 'Hide Example Responses';
          isShowing = true;
        }
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    });
  </script>
{% endblock %}
