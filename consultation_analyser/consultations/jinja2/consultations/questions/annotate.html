{% extends "base.html" %}
{%- from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}
{%- from 'govuk_frontend_jinja/components/textarea/macro.html' import govukTextarea -%}
{%- from 'govuk_frontend_jinja/components/input/macro.html' import govukInput -%}

{% block content %}

  <h1 class="govuk-heading-m">Question Themes</h1>
  {{ govukBreadcrumbs({
    "items": [
      {
        "text": "Back to your consultations",
        "href": "/consultations",
      },
      {
        "text": "Questions",
        "href": "/evaluations/" + consultation_id|string + "/questions/",
      }
    ]
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      
      <div class="govuk-section-break govuk-section-break--m"></div>
      
      <h2 class="govuk-heading-s">Question Text</h2>
      <div class="govuk-inset-text">
        {{ question.text }}
      </div>

      <div class="govuk-section-break govuk-section-break--m"></div>

      <form id="annotation-form" method="post">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        
        <div class="govuk-form-group">
          <h2 class="govuk-label-wrapper">
            <label class="govuk-label govuk-label--s" for="themes">
              Question Themes
            </label>
          </h2>
          <div id="hint-themes" class="govuk-hint">
            Add multiple themes for this question. Each theme should have a name and description.
          </div>
          
          <div id="themes-container">
            <!-- Themes will be added here dynamically -->
          </div>
          
          <button type="button" id="add-theme-btn" class="govuk-button govuk-button--secondary govuk-!-margin-top-2">
            Add Theme
          </button>
        </div>

        <div class="govuk-button-group">
          {{ govukButton({
            "text": "Save Themes",
            "type": "submit"
          }) }}
          
          {{ govukButton({
            "text": "Cancel",
            "classes": "govuk-button--secondary",
            "href": "/evaluations/" + consultation_id|string + "/questions/"
          }) }}
        </div>
      </form>

    </div>

    <div class="govuk-grid-column-one-third">
      <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
          <h2 class="govuk-summary-card__title">Question Details</h2>
        </div>
        <div class="govuk-summary-card__content">
          <dl class="govuk-summary-list">
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Question Number
              </dt>
              <dd class="govuk-summary-list__value">
                {{ question.number }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Has Free Text
              </dt>
              <dd class="govuk-summary-list__value">
                {{ "Yes" if question.has_free_text else "No" }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Has Multiple Choice
              </dt>
              <dd class="govuk-summary-list__value">
                {{ "Yes" if question.has_multiple_choice else "No" }}
              </dd>
            </div>
            {% if question.total_responses %}
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                Total Responses
              </dt>
              <dd class="govuk-summary-list__value">
                {{ question.total_responses }}
              </dd>
            </div>
            {% endif %}
          </dl>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('annotation-form');
      const themesContainer = document.getElementById('themes-container');
      const addThemeBtn = document.getElementById('add-theme-btn');
      let themeCounter = 0;
      
      // Get existing themes from Django context
      const existingThemes = {{ existing_themes|tojson }};

      // Function to create a new theme item
      function createThemeItem(index) {
        const themeItem = document.createElement('div');
        themeItem.className = 'govuk-!-margin-bottom-4 govuk-!-padding-3';
        themeItem.style.border = '2px solid #b1b4b6';
        themeItem.style.borderRadius = '4px';
        themeItem.setAttribute('data-theme-index', index);
        
        themeItem.innerHTML = `
          <div class="govuk-form-group">
            <label class="govuk-label govuk-label--s" for="theme-name-${index}">
              Theme Name
            </label>
            <input class="govuk-input" id="theme-name-${index}" name="theme_name_${index}" type="text" placeholder="Enter theme name">
          </div>
          
          <div class="govuk-form-group">
            <label class="govuk-label govuk-label--s" for="theme-description-${index}">
              Description
            </label>
            <textarea class="govuk-textarea" id="theme-description-${index}" name="theme_description_${index}" rows="3" placeholder="Enter theme description"></textarea>
          </div>
          
          <div class="govuk-button-group">
            <button type="button" class="govuk-button govuk-button--secondary see-responses-btn" data-theme-index="${index}">
              See Responses
            </button>
            <button type="button" class="govuk-button govuk-button--warning remove-theme-btn" data-theme-index="${index}">
              Remove Theme
            </button>
          </div>
          
          <div id="responses-container-${index}" class="responses-container" style="display: none; margin-top: 15px;">
            <h3 class="govuk-heading-s">Related Responses</h3>
            <div id="responses-list-${index}" class="responses-list">
              <!-- Responses will be loaded here -->
            </div>
          </div>
        `;
        
        return themeItem;
      }

      // Function to add a new theme
      function addTheme(themeName = '', themeDescription = '') {
        const themeItem = createThemeItem(themeCounter);
        themesContainer.appendChild(themeItem);
        
        // Populate the theme with data if provided
        if (themeName || themeDescription) {
          document.getElementById(`theme-name-${themeCounter}`).value = themeName;
          document.getElementById(`theme-description-${themeCounter}`).value = themeDescription;
        }
        
        themeCounter++;
        
        // Focus on the first input of the new theme only if it's empty
        if (!themeName) {
          const firstInput = themeItem.querySelector('input[type="text"]');
          if (firstInput) {
            firstInput.focus();
          }
        }
        
        updateRemoveButtons();
      }
      
      // Function to populate existing themes
      function populateExistingThemes() {
        if (existingThemes && existingThemes.length > 0) {
          existingThemes.forEach(theme => {
            addTheme(theme.name || '', theme.description || '');
          });
        } else {
          // Add one empty theme if no existing themes
          addTheme();
        }
      }

      // Function to remove a theme
      function removeTheme(index) {
        const themeItem = document.querySelector(`[data-theme-index="${index}"]`);
        if (themeItem) {
          themeItem.remove();
        }
        updateRemoveButtons();
      }

      // Function to update remove button states
      function updateRemoveButtons() {
        const removeButtons = document.querySelectorAll('.remove-theme-btn');
        const themeItems = document.querySelectorAll('[data-theme-index]');
        
        // Hide remove button if there's only one theme
        removeButtons.forEach(button => {
          button.style.display = themeItems.length <= 1 ? 'none' : 'inline-block';
        });
      }

      // Add event listener for the "Add Theme" button
      addThemeBtn.addEventListener('click', addTheme);

      // Function to get responses for a theme
      function getThemeResponses(index) {
        const themeName = document.getElementById(`theme-name-${index}`).value.trim();
        
        if (!themeName) {
          alert('Please enter a theme name before seeing responses.');
          return;
        }
        
        const responseContainer = document.getElementById(`responses-container-${index}`);
        const responsesList = document.getElementById(`responses-list-${index}`);
        const button = document.querySelector(`[data-theme-index="${index}"].see-responses-btn`);
        
        // Show loading state
        button.textContent = 'Loading...';
        button.disabled = true;
        
        // Make API call to new REST API endpoint
        const consultationId = '{{ consultation_id }}';
        const questionId = '{{ question_id }}';
        const apiUrl = `/api/consultations/${consultationId}/questions/${questionId}/theme-responses/`;
        
        fetch(apiUrl, {
          method: 'POST',
          body: JSON.stringify({
            themes: [{ name: themeName }]
          }),
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Clear previous responses
            responsesList.innerHTML = '';
            
            // Get responses for the single theme
            const themeResponses = data.theme_responses[themeName];
            
            if (!themeResponses || themeResponses.responses.length === 0) {
              responsesList.innerHTML = '<p class="govuk-body">No similar responses found for this theme.</p>';
            } else {
              // Create list of responses
              const responseList = document.createElement('ol');
              responseList.className = 'govuk-list govuk-list--number';
              
              themeResponses.responses.forEach(response => {
                const listItem = document.createElement('li');
                listItem.className = 'govuk-!-margin-bottom-3';
                listItem.innerHTML = `<p class="govuk-body-s" style="background: #f3f2f1; padding: 10px; border-radius: 3px;">${response.free_text}</p>`;
                responseList.appendChild(listItem);
              });
              
              responsesList.appendChild(responseList);
            }
            
            // Show the responses container
            responseContainer.style.display = 'block';
            
            // Update button text to allow hiding
            button.textContent = 'Hide Responses';
            button.setAttribute('data-showing', 'true');
            
          } else {
            alert('Error getting responses: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error getting responses:', error);
          alert('Error getting responses. Please try again.');
        })
        .finally(() => {
          button.disabled = false;
        });
      }
      
      // Function to hide responses
      function hideThemeResponses(index) {
        const responseContainer = document.getElementById(`responses-container-${index}`);
        const button = document.querySelector(`[data-theme-index="${index}"].see-responses-btn`);
        
        responseContainer.style.display = 'none';
        button.textContent = 'See Responses';
        button.removeAttribute('data-showing');
      }

      // Add event listener for buttons (using event delegation)
      themesContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-theme-btn')) {
          const index = e.target.getAttribute('data-theme-index');
          removeTheme(index);
        } else if (e.target.classList.contains('see-responses-btn')) {
          const index = e.target.getAttribute('data-theme-index');
          const isShowing = e.target.getAttribute('data-showing') === 'true';
          
          if (isShowing) {
            hideThemeResponses(index);
          } else {
            getThemeResponses(index);
          }
        }
      });

      // Populate existing themes or add empty theme
      populateExistingThemes();

      // Form submission handler
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Collect all theme data
        const themeItems = document.querySelectorAll('[data-theme-index]');
        const themes = [];
        
        themeItems.forEach(item => {
          const index = item.getAttribute('data-theme-index');
          const name = document.getElementById(`theme-name-${index}`).value;
          const description = document.getElementById(`theme-description-${index}`).value;
          
          if (name || description) {
            themes.push({
              name: name,
              description: description
            });
          }
        });

        // Create FormData and add themes as JSON
        const formData = new FormData(form);
        formData.set('themes', JSON.stringify(themes));
        
        fetch(window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Show success message
            const successBanner = document.createElement('div');
            successBanner.className = 'govuk-notification-banner govuk-notification-banner--success';
            successBanner.setAttribute('role', 'alert');
            successBanner.innerHTML = `
              <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                  Success
                </h2>
              </div>
              <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                  ${data.message}
                </p>
              </div>
            `;
            
            const content = document.querySelector('.govuk-grid-row');
            content.parentNode.insertBefore(successBanner, content);
            
            // Scroll to top to show the banner
            window.scrollTo(0, 0);
            
            // Remove banner after 5 seconds
            setTimeout(() => {
              successBanner.remove();
            }, 5000);
          }
        })
        .catch(error => {
          console.error('Error saving themes:', error);
          alert('Error saving themes. Please try again.');
        });
      });
    });
  </script>

{% endblock %}