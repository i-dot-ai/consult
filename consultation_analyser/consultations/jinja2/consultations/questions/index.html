{% extends "base.html" %}
{%- from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs -%}
{%- from 'govuk_frontend_jinja/components/button/macro.html' import govukButton -%}

{% block content %}

  <h1 class="govuk-heading-m" id="consultation-title">Loading...</h1>
  {{ govukBreadcrumbs({
    "items": [
      {
        "text": "Back to your consultations",
        "href": "/consultations",
      }
    ]
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <div class="con-question-list">
        <h2 class="govuk-body govuk-!-font-weight-bold govuk-!-padding-bottom-1 govuk-!-padding-top-5 govuk-!-padding-left-7 govuk-!-padding-right-7">All free text questions for review</h2>
        <ul class="govuk-body govuk-!-padding-0" id="questions-list">
          <!-- Questions will be loaded here via JavaScript -->
        </ul>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const consultationId = '{{ consultation_id }}';

      // First fetch the consultation to get the ID and title
      fetch(`/api/consultations/${consultationId}/`)
        .then(response => response.json())
        .then(consultation => {
          document.getElementById('consultation-title').textContent = consultation.title;
          document.title = consultation.title;

          // Now fetch questions with free text and themes
          return fetch(`/api/consultations/${consultation.id}/questions/?has_free_text=true&has_free_text=true`);
        })
        .then(response => response.json())
        .then(data => {
          const questionsList = document.getElementById('questions-list');

          data.results.forEach(question => {
            const listItem = document.createElement('li');
            listItem.className = 'con-question-list__item iai-display-flex govuk-!-padding-top-4 govuk-!-padding-bottom-4 govuk-!-padding-left-7 govuk-!-padding-right-7';

            const percentage = Math.round(question.proportion_of_audited_answers * 100);

            listItem.innerHTML = `
              <p class="govuk-!-margin-bottom-1 govuk-!-margin-top-0">${question.question_text}</p>
              <div class="con-question-list__button-group iai-display-flex govuk-!-margin-left-3">
                <p class="govuk-body">${percentage}% reviewed</p>
                <a class="iai-icon-button iai-icon-button--with-circle govuk-!-margin-left-5" href="/evaluations/${consultationId}/questions/${question.id}/show-next/">
                  <svg width="18" height="13" viewBox="0 0 18 13" fill="none" focusable="false" aria-hidden="true">
                    <path d="M1 6.71429C1 6.71429 3.90857 1 9 1C14.0903 1 17 6.71429 17 6.71429C17 6.71429 14.0903 12.4286 9 12.4286C3.90857 12.4286 1 6.71429 1 6.71429Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.00003 7.85713C9.30314 7.85713 9.59383 7.73672 9.80816 7.52239C10.0225 7.30806 10.1429 7.01737 10.1429 6.71427C10.1429 6.41116 10.0225 6.12047 9.80816 5.90615C9.59383 5.69182 9.30314 5.57141 9.00003 5.57141C8.69693 5.57141 8.40624 5.69182 8.19191 5.90615C7.97759 6.12047 7.85718 6.41116 7.85718 6.71427C7.85718 7.01737 7.97759 7.30806 8.19191 7.52239C8.40624 7.73672 8.69693 7.85713 9.00003 7.85713Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Show next
                </a>
              </div>
            `;

            questionsList.appendChild(listItem);
          });
        })
        .catch(error => {
          console.error('Error loading data:', error);
          document.getElementById('consultation-title').textContent = 'Error loading consultation';
          document.getElementById('questions-list').innerHTML = '<li class="govuk-!-padding-7">Error loading questions. Please refresh the page.</li>';
        });
    });
  </script>

{% endblock %}
