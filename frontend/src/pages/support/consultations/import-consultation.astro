---
import { fetchBackendApi } from "../../../global/api";
import type { Consultation } from "../../../global/types";
import Layout from "../../../layouts/Layout.astro";
import Section from "../../../components/Section/Section.svelte";
import Details from "../../../components/Details/Details.svelte";
import Text from '../../../components/Text/Text.svelte';
import Title from "../../../components/Title.svelte";
import ImportImmutableDataForm from "../../../components/screens/ImportImmutableDataForm.svelte";
import ImportCandidateThemesForm from "../../../components/screens/ImportCandidateThemesForm.svelte";
import ImportResponseAnnotationsForm from "../../../components/screens/ImportResponseAnnotationsForm.svelte";
import Link from "../../../components/Link.svelte";

const bucketName = process.env?.AWS_BUCKET_NAME

// Fetch consultation folders for immutable data import
const foldersData = await fetchBackendApi<Array<{text: string, value: string}>>(Astro, "/api/consultations/folders/");
const consultationFolders = foldersData.map((folder) => ({
  value: folder.value,
  label: folder.text
}));

// Fetch existing consultations for candidate themes and annotations imports
const consultationsData = await fetchBackendApi<{ results: Consultation[]}>(Astro, "/api/consultations/?scope=all");
const existingConsultations = consultationsData.results.map((consultation) => ({
  value: consultation.code,
  label: `${consultation.title} (${consultation.code})`
}));
---

<Layout>
  <Section>
    <Title level={1} text="Consultation import" />
    <Text>Import consultation data in stages using the refactored ingestion pipeline.</Text>
    <Text>Data should be saved in: "{bucketName}/app_data/consultations/[CONSULTATION FOLDER]"</Text>

    <Details summaryText="Expected S3 Structure">
        <pre><code>&lt;consultation-folder&gt;/
        ├── inputs/
        │   ├── respondents.jsonl
        │   ├── question_part_1/
        │   │   ├── question.json
        │   │   ├── responses.jsonl
        │   │   └── multi_choice.jsonl
        │   └── question_part_2/
        │       ├── question.json
        │       └── responses.jsonl
        └── outputs/
            ├── sign_off/
            │   └── &lt;timestamp&gt;/
            │       ├── question_part_1/
            │       │   └── clustered_themes.json
            │       └── question_part_2/
            │           └── clustered_themes.json
            └── mapping/
                └── &lt;timestamp&gt;/
                    ├── question_part_1/
                    │   ├── themes.json
                    │   ├── sentiment.jsonl [optional]
                    │   ├── detail_detection.jsonl
                    │   └── mapping.jsonl
                    └── question_part_2/
                        ├── themes.json
                        ├── sentiment.jsonl [optional]
                        ├── detail_detection.jsonl
                        └── mapping.jsonl</code></pre>
    </Details>
  </Section>

  <hr class="govuk-section-break govuk-section-break--xl govuk-section-break--visible">

  <Section>
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem;">1. Create consultation and import immutable data</h2>

    <p style="font-size: 1.1rem; margin-bottom: 1rem;"><strong>What this does:</strong> Creates a new consultation and imports the foundational data that doesn't change throughout the consultation lifecycle.</p>

    <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">What this creates:</p>
    <ul style="list-style-type: disc; margin-left: 2rem; margin-bottom: 1rem;">
      <li>A new consultation record</li>
      <li>Respondents and their demographic data</li>
      <li>Questions and their configuration (free text, multiple choice)</li>
      <li>Response text (both free text and multiple choice answers)</li>
      <li>Response embeddings (generated asynchronously in the background)</li>
    </ul>

    <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">What this depends on:</p>
    <ul style="list-style-type: disc; margin-left: 2rem; margin-bottom: 1rem;">
      <li>S3 data in <code>app_data/consultations/[code]/inputs/</code></li>
      <li>Nothing - this is always the first step</li>
    </ul>

    <div style="padding: 1rem; margin-top: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid #0b0c0c; background-color: #f3f2f1;">
      <strong>⚠️ Important:</strong> This must be completed before importing any AI outputs (steps 2 and 3).
    </div>

    <Details summaryText="Show import form">
      <ImportImmutableDataForm client:load consultationFolders={consultationFolders}/>
    </Details>
  </Section>

  <hr class="govuk-section-break govuk-section-break--xl govuk-section-break--visible">

  <Section>
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem;">2. Import candidate themes to existing consultation</h2>

    <p style="font-size: 1.1rem; margin-bottom: 1rem;"><strong>What this does:</strong> Imports AI-generated candidate themes from the themefinder pipeline for the sign-off workflow.</p>

    <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">What this creates:</p>
    <ul style="list-style-type: disc; margin-left: 2rem; margin-bottom: 1rem;">
      <li>Candidate themes with hierarchical parent-child relationships</li>
      <li>Theme names and descriptions</li>
      <li>Approximate frequency counts for each theme</li>
    </ul>

    <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">What this depends on:</p>
    <ul style="list-style-type: disc; margin-left: 2rem; margin-bottom: 1rem;">
      <li>Consultation must already exist (created in step 1)</li>
      <li>AWS Batch sign-off processing must be complete</li>
      <li>S3 data in <code>app_data/consultations/[code]/outputs/sign_off/[timestamp]/</code></li>
    </ul>

    <Details summaryText="Show import form">
      <ImportCandidateThemesForm client:load existingConsultations={existingConsultations}/>
    </Details>
  </Section>

  <hr class="govuk-section-break govuk-section-break--xl govuk-section-break--visible">

  <Section>
    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem;">3. Import response annotations to existing consultation</h2>

    <p style="font-size: 1.1rem; margin-bottom: 1rem;"><strong>What this does:</strong> Imports the final AI analysis results that power the consultation dashboard.</p>

    <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">What this creates:</p>
    <ul style="list-style-type: disc; margin-left: 2rem; margin-bottom: 1rem;">
      <li>Selected themes (final approved theme list)</li>
      <li>Response annotations with sentiment analysis (if available)</li>
      <li>Evidence-rich detection flags</li>
      <li>Theme-to-response mappings</li>
    </ul>

    <p style="font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;">What this depends on:</p>
    <ul style="list-style-type: disc; margin-left: 2rem; margin-bottom: 1rem;">
      <li>Consultation must already exist (created in step 1)</li>
      <li>AWS Batch mapping processing must be complete</li>
      <li>S3 data in <code>app_data/consultations/[code]/outputs/mapping/[timestamp]/</code></li>
    </ul>

    <Details summaryText="Show import form">
      <ImportResponseAnnotationsForm client:load existingConsultations={existingConsultations}/>
    </Details>
  </Section>

  <Section>
    <Title level={2} text="Import progress" />
    <Text>Check the <Link href="/support/django-rq/">Django RQ dashboard</Link> to monitor import progress.</Text>
  </Section>
</Layout>